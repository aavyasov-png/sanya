# üéØ –ü–õ–ê–ù –ó–ê–ö–†–´–¢–ò–Ø –ü–†–û–ë–ï–õ–û–í (GAP CLOSURE PLAN)

**–°—Ç–∞—Ç—É—Å:** –®–ê–ì 0 –∑–∞–≤–µ—Ä—à—ë–Ω - –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤  
**–ü–æ–¥—Ö–æ–¥:** –¢–æ–ª—å–∫–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ (NO REWRITES)

---

## üìä –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø –ü–†–û–ë–ï–õ–û–í

### –ë–õ–û–ö–ò–†–£–Æ–©–ò–ï –ü–†–û–ë–ï–õ–´ (–®–ê–ì 1-7 + Production)

| # | –ü—Ä–æ–±–µ–ª | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç | –¢—Ä–µ–±—É–µ—Ç | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|---|--------|-----------|---------|-------|--------|
| **P1** | FAQ: –¥–æ–±–∞–≤–∏—Ç—å slug/category | –®–ê–ì 6 | –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î + —Ñ–æ—Ä–º–∞ | 1—á | ‚ùå TODO |
| **P2** | Microcopy: —Ç–∞–±–ª–∏—Ü–∞ + UI | –®–ê–ì 7 | –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î + –∫–æ–º–ø–æ–Ω–µ–Ω—Ç | 1.5—á | ‚ùå TODO |
| **P3** | Users Management –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | Production | –î–æ–±–∞–≤–∏—Ç—å tab + button | 0.5—á | ‚ùå TODO |
| **P4** | Audit Logging —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è | Production | API + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ CRUD | 2—á | ‚ùå TODO |

### –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ë–ï–õ–´ (Production Ready)

| # | –ü—Ä–æ–±–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|---|--------|---------|-------|--------|
| **P5** | Access Codes: –≤–∞–ª–∏–¥–∞—Ü–∏—è | Server-side –ø—Ä–æ–≤–µ—Ä–∫–∏ | 1.5—á | ‚ùå TODO |
| **P6** | Settings —Ç–∞–±–ª–∏—Ü–∞ | –ú–∏–≥—Ä–∞—Ü–∏—è + –∫–æ–º–ø–æ–Ω–µ–Ω—Ç | 1.5—á | ‚ùå TODO |
| **P7** | RBAC Security (JWT) | Cloudflare Worker + cookie | 3—á | ‚ùå TODO |

### –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ë–ï–õ–´ (Nice-to-have)

| # | –ü—Ä–æ–±–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|---|--------|---------|-------|--------|
| **P8** | Content validation | –ü—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —è–∑—ã–∫–æ–≤ | 0.5—á | ‚ö†Ô∏è  BACKLOG |
| **P9** | Rate limiting –Ω–∞ –∫–æ–¥–∞—Ö | Server-side counter | 1—á | ‚ö†Ô∏è  BACKLOG |
| **P10** | Full-text search | PostgreSQL tsvector | 1.5—á | ‚ö†Ô∏è  BACKLOG |

---

## üîß –ü–õ–ê–ù –ó–ê–ö–†–´–¢–ò–Ø –ü–†–û–ë–ï–õ–û–í (–ü–û –ü–û–†–Ø–î–ö–£)

### –®–ê–ì P1: FAQ —Å slug –∏ category

**–°—Ç–∞—Ç—É—Å:** ‚ùå NOT STARTED  
**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:** –®–ê–ì 6 (ContextualFaqLink)  
**–í—Ä–µ–º—è:** ~1 —á–∞—Å  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 1 —Ñ–∞–π–ª, ~20 —Å—Ç—Ä–æ–∫ SQL  
**–ö–æ–¥:** 2 –º–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É faq
   ```sql
   -- migrations/003_faq_enhance.sql
   ALTER TABLE faq ADD COLUMN IF NOT EXISTS slug TEXT UNIQUE;
   ALTER TABLE faq ADD COLUMN IF NOT EXISTS category TEXT DEFAULT 'general';
   CREATE INDEX IF NOT EXISTS idx_faq_slug ON faq(slug);
   CREATE INDEX IF NOT EXISTS idx_faq_category ON faq(category);
   ```

2. **Admin UI** - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ —Ñ–æ—Ä–º—É FAQ
   - Input –¥–ª—è slug (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑ question_ru)
   - Select –¥–ª—è category (calculator, commissions, general)

3. **ContextualFaqLink** - —É–∂–µ –≥–æ—Ç–æ–≤, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   - –ò—â–µ—Ç –ø–æ slug: `findFaqBySlug(slug)`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ 3 –º–µ—Å—Ç–∞—Ö (–®–ê–ì 6 —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)

#### –§–∞–∏–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚ùå `migrations/003_faq_enhance.sql` (—Å–æ–∑–¥–∞—Ç—å)
- üìù `src/App.tsx` (–¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ faqForm + —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [ ] FAQ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ slug
- [ ] ContextualFaqLink —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ slug
- [ ] Backward compatible (—Å—Ç–∞—Ä—ã–µ FAQ –±–µ–∑ slug —Ä–∞–±–æ—Ç–∞—é—Ç)

---

### –®–ê–ì P2: Microcopy —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–°—Ç–∞—Ç—É—Å:** ‚ùå NOT STARTED  
**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:** –®–ê–ì 7 (Micro-texts)  
**–í—Ä–µ–º—è:** ~1.5 —á–∞—Å–∞  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 1 —Ñ–∞–π–ª, ~25 —Å—Ç—Ä–æ–∫ SQL  
**–ö–æ–¥:** 3 –º–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** - —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É microcopy
   ```sql
   -- migrations/004_microcopy_table.sql
   CREATE TABLE IF NOT EXISTS microcopy (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     key TEXT NOT NULL UNIQUE,
     text_ru TEXT NOT NULL,
     text_uz TEXT NOT NULL,
     context TEXT, -- 'login', 'home', 'uzum', etc
     sort INTEGER DEFAULT 0,
     created_at TIMESTAMPTZ DEFAULT now(),
     updated_at TIMESTAMPTZ DEFAULT now()
   );
   
   -- –í—Å—Ç–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ micro-texts
   INSERT INTO microcopy (key, text_ru, text_uz, context) VALUES
     ('login_info', 'üîê –ö–æ–¥ –Ω—É–∂–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É', 'üîê Tizimga kirish uchun kod kerak', 'login'),
     ('home_welcome', 'üëã –ú—ã –ø–æ–º–æ–∂–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –∏ –Ω–∞—á–∞—Ç—å –ø—Ä–æ–¥–∞–∂–∏', 'üëã Biz boshlamoq va sotishni boshlashga yordam beramiz', 'home');
   ```

2. **Admin UI** - –¥–æ–±–∞–≤–∏—Ç—å tab "microcopy"
   - Form: key, text_ru, text_uz, context
   - List: –≤—Å–µ microcopy —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º/—É–¥–∞–ª–µ–Ω–∏–µ–º
   - RBAC: ADMIN+ (–∫–∞–∫ FAQ)

3. **App.tsx** - –∑–∞–º–µ–Ω–∏—Ç—å hardcoded —Ç–µ–∫—Å—Ç –Ω–∞ loadMicrocopy()
   ```typescript
   const [microcopy, setMicrocopy] = useState<Record<string, { ru: string; uz: string }>>({});
   
   const loadMicrocopy = async () => {
     const { data } = await supabase.from('microcopy').select('*');
     const map: Record<string, any> = {};
     data?.forEach(item => {
       map[item.key] = { ru: item.text_ru, uz: item.text_uz };
     });
     setMicrocopy(map);
   };
   
   useEffect(() => { loadMicrocopy(); }, []);
   ```

#### –§–∞–∏–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚ùå `migrations/004_microcopy_table.sql` (—Å–æ–∑–¥–∞—Ç—å)
- üìù `src/App.tsx` (–¥–æ–±–∞–≤–∏—Ç—å state, —Ñ—É–Ω–∫—Ü–∏–∏, tab, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
- [ ] –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å initial –¥–∞–Ω–Ω—ã–º–∏
- [ ] –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å microcopy
- [ ] –¢–µ–∫—Å—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ë–î, –Ω–µ hardcoded
- [ ] –û–±–∞ —è–∑—ã–∫–∞ —Ä–∞–±–æ—Ç–∞—é—Ç (RU + UZ)

---

### –®–ê–ì P3: Users Management –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚ùå NOT STARTED  
**–¢—Ä–µ–±—É–µ—Ç:** 30 –º–∏–Ω—É—Ç –∫–æ–¥–∞  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 0 —Ñ–∞–π–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)  
**–ö–æ–¥:** 1-2 –º–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **–î–æ–±–∞–≤–∏—Ç—å tab –≤ –∞–¥–º–∏–Ω –º–µ–Ω—é**
   ```tsx
   {canFullAccess() && (
     <button className="btnGhost" onClick={() => setAdminTab("users")}>
       üë• {t.manageUsers} {/* –¥–æ–±–∞–≤–∏—Ç—å –≤ T –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã */}
     </button>
   )}
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å tab handler**
   ```tsx
   {canFullAccess() && adminTab === "users" && (
     <UsersManagement userRole={userRole} />
   )}
   ```

3. **–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç**
   ```tsx
   import UsersManagement from "./components/UsersManagement";
   ```

#### –§–∞–∏–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- üìù `src/App.tsx` (–¥–æ–±–∞–≤–∏—Ç—å import, button, tab handler, T.manageUsers)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
- [ ] –ö–Ω–æ–ø–∫–∞ "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ OWNER
- [ ] Tab –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç UsersManagement
- [ ] –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

### –®–ê–ì P4: Audit Logging —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚ùå NOT STARTED  
**–¢—Ä–µ–±—É–µ—Ç:** 2 —á–∞—Å–∞ –∫–æ–¥–∞  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 0 —Ñ–∞–π–ª–æ–≤ (—Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ –µ—Å—Ç—å)  
**–ö–æ–¥:** 3-4 –º–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **–§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ App.tsx**
   ```typescript
   const logAction = async (action: string, resourceType: string, resourceId?: string, details?: any) => {
     try {
       await supabase.from('audit_log').insert({
         user_id: (window as any).currentUserId, // –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
         action,
         resource_type: resourceType,
         resource_id: resourceId,
         details: details || {},
         ip_address: 'client-side', // –≤ production —ç—Ç–æ server
         user_agent: navigator.userAgent,
       });
     } catch (err) {
       console.error('Audit log error:', err);
     }
   };
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã –≤ CRUD —Ñ—É–Ω–∫—Ü–∏–∏**
   ```typescript
   const adminSaveSection = async () => {
     // ... existing code ...
     await logAction('create', 'section', newSection.id, { title: newSection.title_ru });
   };
   
   // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è adminSaveCard, adminSaveNews, adminSaveFaq, adminSaveCode
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å tab –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ audit_log**
   ```tsx
   {canManage() && adminTab === "audit" && (
     <AuditLogViewer />
   )}
   ```

4. **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç AuditLogViewer**
   ```tsx
   // src/components/AuditLogViewer.tsx
   - Table —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: user, action, resource, date, details
   - –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Ç–∏–ø—É –¥–µ–π—Å—Ç–≤–∏—è
   - –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
   ```

#### –§–∞–∏–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚ùå `src/components/AuditLogViewer.tsx` (—Å–æ–∑–¥–∞—Ç—å)
- üìù `src/App.tsx` (–¥–æ–±–∞–≤–∏—Ç—å logAction, –≤—ã–∑–æ–≤—ã, tab)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
- [ ] –ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ audit_log
- [ ] –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
- [ ] –§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç

---

### –®–ê–ì P5: Access Codes –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚ùå NOT STARTED  
**–¢—Ä–µ–±—É–µ—Ç:** 1.5 —á–∞—Å–∞ –∫–æ–¥–∞  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 1 —Ñ–∞–π–ª, ~10 —Å—Ç—Ä–æ–∫  
**–ö–æ–¥:** 1-2 –º–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è tracking –ø–æ–ø—ã—Ç–æ–∫** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   ```sql
   ALTER TABLE access_codes ADD COLUMN IF NOT EXISTS last_used_at TIMESTAMPTZ;
   ALTER TABLE access_codes ADD COLUMN IF NOT EXISTS last_used_by_telegram_id BIGINT;
   ```

2. **–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–¥–∞ –≤ App.tsx**
   ```typescript
   const verifyCode = async (entered: string) => {
     const codeHash = await hashCode(entered);
     
     const { data, error } = await supabase
       .from('access_codes')
       .select('id,role,is_active,expires_at,max_uses,uses_count')
       .eq('code_hash', codeHash)
       .eq('is_active', true)
       .single();
     
     if (error || !data) {
       showToast(t.invalidCode);
       return;
     }
     
     // –ù–û–í–û–ï: –í–∞–ª–∏–¥–∞—Ü–∏—è max_uses
     if (data.max_uses && data.uses_count >= data.max_uses) {
       showToast('–ö–æ–¥ –∏—Å—á–µ—Ä–ø–∞–Ω');
       return;
     }
     
     // –ù–û–í–û–ï: –í–∞–ª–∏–¥–∞—Ü–∏—è expires_at
     if (data.expires_at && new Date(data.expires_at) < new Date()) {
       showToast('–ö–æ–¥ –∏—Å—Ç—ë–∫');
       return;
     }
     
     // –£—Å–ø–µ—à–Ω–æ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º uses_count
     await supabase
       .from('access_codes')
       .update({
         uses_count: data.uses_count + 1,
         last_used_at: new Date().toISOString(),
       })
       .eq('id', data.id);
     
     // ... rest of verification ...
   };
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å rate limiting (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
   - localStorage: –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å failed attempts
   - –ü–æ–∫–∞–∑–∞—Ç—å cooldown: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ N —Å–µ–∫—É–Ω–¥"

#### –§–∞–∏–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚ùå `migrations/005_access_codes_tracking.sql` (—Å–æ–∑–¥–∞—Ç—å)
- üìù `src/App.tsx` (—É–ª—É—á—à–∏—Ç—å verifyCode function)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
- [ ] uses_count —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- [ ] max_uses —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è (–∫–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –ª–∏–º–∏—Ç–∞)
- [ ] expires_at —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è (–∫–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –¥–∞—Ç—ã)
- [ ] Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç (–º–∞–∫—Å 3 –ø–æ–ø—ã—Ç–∫–∏ –∑–∞ 5 –º–∏–Ω—É—Ç)

---

### –®–ê–ì P6: Settings —Ç–∞–±–ª–∏—Ü–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–°—Ç–∞—Ç—É—Å:** ‚ùå NOT STARTED  
**–¢—Ä–µ–±—É–µ—Ç:** 1.5 —á–∞—Å–∞ –∫–æ–¥–∞  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 1 —Ñ–∞–π–ª, ~30 —Å—Ç—Ä–æ–∫ SQL  
**–ö–æ–¥:** 2 –º–µ—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î**
   ```sql
   CREATE TABLE IF NOT EXISTS settings (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     key TEXT NOT NULL UNIQUE,
     value_type TEXT CHECK (value_type IN ('string', 'number', 'boolean', 'json')),
     value_ru TEXT,
     value_uz TEXT,
     description TEXT,
     created_at TIMESTAMPTZ DEFAULT now(),
     updated_at TIMESTAMPTZ DEFAULT now()
   );
   
   INSERT INTO settings (key, value_type, value_ru, value_uz, description) VALUES
     ('app_title', 'string', '–£–∑—É–º –ü—Ä–æ–¥–∞–≤–µ—Ü', 'Uzum Sotuvchi', 'App title'),
     ('default_language', 'string', 'ru', 'ru', 'Default language'),
     ('max_code_attempts', 'number', '3', '3', 'Max failed attempts'),
     ('faq_page_size', 'number', '10', '10', 'FAQ items per page');
   ```

2. **Admin UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç**
   - Tab "settings" (ADMIN+ only)
   - Table —Å key, value_ru, value_uz, description
   - Form –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

3. **App.tsx - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**
   ```typescript
   const [settings, setSettings] = useState<Record<string, any>>({});
   
   const loadSettings = async () => {
     const { data } = await supabase.from('settings').select('*');
     const map: Record<string, any> = {};
     data?.forEach(item => {
       map[item.key] = item.value_ru; // –∏–ª–∏ value_uz –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç lang
     });
     setSettings(map);
   };
   ```

#### –§–∞–∏–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚ùå `migrations/006_settings_table.sql` (—Å–æ–∑–¥–∞—Ç—å)
- ‚ùå `src/components/SettingsEditor.tsx` (—Å–æ–∑–¥–∞—Ç—å)
- üìù `src/App.tsx` (–¥–æ–±–∞–≤–∏—Ç—å state, loadSettings, tab)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
- [ ] –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- [ ] –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å settings
- [ ] Settings –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- [ ] –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î

---

### –®–ê–ì P7: RBAC Security (JWT –≤–º–µ—Å—Ç–æ localStorage)

**–°—Ç–∞—Ç—É—Å:** ‚ùå NOT STARTED  
**–¢—Ä–µ–±—É–µ—Ç:** 3 —á–∞—Å–∞ –∫–æ–¥–∞ (—Å–ª–æ–∂–Ω–µ–π—à–∏–π)  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 0 —Ñ–∞–π–ª–æ–≤ (—Ç–∞–±–ª–∏—Ü—ã —É–∂–µ –µ—Å—Ç—å)  
**–ö–æ–¥:** Cloudflare Worker + 5-10 –º–µ—Å—Ç –≤ App.tsx

#### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **Cloudflare Worker** (—Ñ—É–Ω–∫—Ü–∏–∏/api/auth/verify-code)
   - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JWT token –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–¥–∞
   - –°–æ—Ö—Ä–∞–Ω—è—Ç—å session –≤ user_sessions —Ç–∞–±–ª–∏—Ü–µ
   - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å token –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å httpOnly cookie

2. **App.tsx - –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ JWT**
   ```typescript
   // –°–¢–ê–†–û–ï: localStorage
   // localStorage.setItem("user_role", role);
   
   // –ù–û–í–û–ï: JWT –≤ httpOnly cookie (–±—Ä–∞—É–∑–µ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç)
   // API Client –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
   ```

3. **API Client** - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É token
   ```typescript
   if (!this.token && !this.isCookieAuth()) {
     throw new Error('Not authenticated');
   }
   ```

4. **Supabase RLS** - –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏
   ```sql
   -- –í–º–µ—Å—Ç–æ USING (true) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
   USING (auth.uid() = user_id OR auth.role() = 'admin')
   ```

#### –§–∞–∏–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- üöÄ `functions/api/auth/verify-code.js` (—Ä–∞—Å—à–∏—Ä–∏—Ç—å)
- üìù `src/lib/api.ts` (–¥–æ–±–∞–≤–∏—Ç—å JWT –æ–±—Ä–∞–±–æ—Ç–∫—É)
- üìù `src/App.tsx` (—É–±—Ä–∞—Ç—å localStorage RBAC)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
- [ ] JWT token –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ login
- [ ] Token —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ httpOnly cookie
- [ ] API –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç token
- [ ] Session —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ user_sessions
- [ ] –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] localStorage –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–æ–ª—å

---

## üìÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –ü–û–†–Ø–î–û–ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –ù–ï–î–ï–õ–Ø 1: –û—Å–Ω–æ–≤–Ω–æ–µ (–®–ê–ì 1-7 + P1, P2, P3)
```
–î–µ–Ω—å 1: P1 - FAQ slug/category      (1 —á–∞—Å)
–î–µ–Ω—å 2: P2 - Microcopy —Ç–∞–±–ª–∏—Ü–∞      (1.5 —á–∞—Å–∞)
–î–µ–Ω—å 3: P3 - Users Management       (0.5 —á–∞—Å–∞)
–î–µ–Ω—å 3: P4 - Audit Logging (—á–∞—Å—Ç—å 1) (1 —á–∞—Å)
–î–µ–Ω—å 4: P4 - Audit Logging (—á–∞—Å—Ç—å 2) (1 —á–∞—Å)
```

### –ù–ï–î–ï–õ–Ø 2: Production-ready (P5, P6, P7)
```
–î–µ–Ω—å 1: P5 - Access Codes validate   (1.5 —á–∞—Å–∞)
–î–µ–Ω—å 2: P6 - Settings —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ    (1.5 —á–∞—Å–∞)
–î–µ–Ω—å 3-5: P7 - JWT & Security       (3 —á–∞—Å–∞)
```

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~12 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã

---

## ‚úÖ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–´–ô –ß–ï–ö–õ–ò–°–¢

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
- [ ] ADMIN_GAP.md –ø—Ä–æ—á–∏—Ç–∞–Ω –∏ –ø–æ–Ω—è—Ç
- [ ] ARCHITECTURE.md –∏–∑—É—á–µ–Ω–∞
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã
- [ ] Backup –ë–î —Å–¥–µ–ª–∞–Ω

### –î–ª—è –∫–∞–∂–¥–æ–≥–æ –®–ê–ì–∞
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞
- [ ] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –∏ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
- [ ] UI –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≤–∏–¥–∏–º—ã–π
- [ ] RBAC –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
- [ ] –û–±–∞ —è–∑—ã–∫–∞ (RU/UZ) —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] –ö–æ–º–º–∏—Ç —Å–¥–µ–ª–∞–Ω

### –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –®–ê–ì–æ–≤
- [ ] –í–µ—Å—å –∫–æ–¥ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] App —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production —Ä–µ–∂–∏–º–µ
- [ ] –í—Å–µ endpoints –¥–æ—Å—Ç—É–ø–Ω—ã
- [ ] RBAC —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è
- [ ] Audit log –ø–æ–ª–Ω—ã–π –∏ —Ç–æ—á–Ω—ã–π
- [ ] JWT tokens —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Backward compatible (—Å—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ)

---

## üéØ SUCCESS CRITERIA

**–®–ê–ì 0 –∑–∞–≤–µ—Ä—à—ë–Ω –∫–æ–≥–¥–∞:**
‚úÖ ADMIN_GAP.md —Å–æ–∑–¥–∞–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å  
‚úÖ ARCHITECTURE.md –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É  
‚úÖ –í—Å–µ –ø—Ä–æ–±–µ–ª—ã (P1-P10) –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã  
‚úÖ –ü–ª–∞–Ω –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é  

**–ü—Ä–æ–µ–∫—Ç ready for production –∫–æ–≥–¥–∞:**
‚úÖ P1-P7 –∑–∞–∫—Ä—ã—Ç—ã  
‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏  
‚úÖ Backward compatible —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏  
‚úÖ Security audit –ø—Ä–æ–π–¥–µ–Ω  
‚úÖ Performance acceptable (<500ms –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)  
‚úÖ –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞  
